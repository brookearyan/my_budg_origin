<!DOCTYPE html>
<html>
  <head>

    <style media="screen">

      * {
        box-sizing: border-box;
      }

      body {
        background-color: #FAFBFC;
        font-family: 'Open Sans', sans-serif;
      }

      th, h1, h2, h3{
        font-family: 'Abril Fatface', cursive;
        letter-spacing: 1.5px;
      }

      td {
      width: 25%;
      text-align: left;
      }

      h1 {
        text-align: center;
        margin-top: 35px;
      }

      h3 {
        font-size: 30px;
      }

      section {
        width: 1000px;
        margin: 0 auto;
        float: left;
        display: inline-block;
      }

      article {
        margin: 10px;
        float: left;
        display: inline-block;
        line-height: 1.5;
        letter-spacing: 1px;
      }

      .info {
        font-size: 18px;
      }

      #expenses, #bills {
        width: 1000px;
      }

      #title {
        height: 30px;
        margin: 10px;
      }

      .footer{
        font-family: 'Open Sans', sans-serif;
        clear: both;
        text-align: center;
      }



    </style>
    <!-- <meta charset="utf-6"> -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="/user.js" type="text/javascript">

    </script>
    <title></title>
  </head>
  <body>
    <% provide(:title, @user.name) %>
    <div class="user-profile">
      <section class="user-info">
        <h1>your profile</h1><br>
          <table id="user"></table>
        </section><br><br>

      <section>
          <article class="exp-info">
            <h3 id='title'>expenses</h3>

          <table colspan="4" id="expenses">
              <row>
                <th>name</th>
                <th>type</th>
                <th>cost</th>
                <th>current total</th>
              </row>
          </table>
        </article><br><br>

        <article class="bill-info">
          <h3 id='title'>bills</h3>

          <table colspan="4" id="bills">
              <row>
                <th>company</th>
                <th>type</th>
                <th>cost</th>
                <th>current total</th>
              </row>
          </table>
        </article>
      </section>


        <div class="footer">
          <h3><%= link_to "add expenses", new_expense_path(current_user) %> |
          <%= link_to "add bills", new_bill_path(current_user) %></h3>
        </div>
    </div>
        <script>
          $(document).ready(function(){
            const url = window.location.href;
            fetch(url, { headers :
              { 'Content-Type': 'application/json',
                'Accept': 'application/json' }
                })
                .then(res => res.json())
                .then(json => userCont(json));

              function userCont(json) {
                var formatter = new Intl.NumberFormat('en-US', {
                  style: 'currency',
                  currency: 'USD',
                  minimumFractionDigits: 2,
                });


                let income = formatter.format(json.income);
                let afterTax = Math.floor(json['income']*=.65);
                let monthly = Math.floor(afterTax/12);

                let afterTaxF = formatter.format(afterTax);
                let monthlyF = formatter.format(monthly);


                const userInfo =
                `<tr>
                  <th colspan="6">${json.name}</th>
                </tr><br>
                <tr>
                <td> email: </td><td>${json.email}</td>
                </tr>
                <tr>
                <td> password: </td><td> *********** </td>
                </tr>
                </tr>
                <td> zipcode: </td><td>${json.zipcode}</td>
                <tr>
                </tr>
                <td> annual income: </td><td>${income}</td>
                <tr>
                </tr>
                <td> after-tax income: </td><td>${afterTaxF}</td>
                <tr>
                </tr>
                <td> gross income: </td><td>${monthlyF}</td>
                <tr>`;
                $('#user').append(userInfo);

                let list = json['expenses'];

                let listB = json['bills'];

                let eTotal = 0;

                list.forEach(e => {
                  eTotal+=(parseInt(e['cost']));
                  let esum = formatter.format(eTotal);

                  let exp =
                  `<tr><td>${e.name}</td>
                  <td>${e.expense_type}</td>
                  <td>${e.cost}</td>
                  <td>${esum}</td></tr>`;
                  $('#expenses').append(exp);

                })

                let bTotal = 0;

                listB.forEach(b => {
                  bTotal+=(parseInt(b['cost']));
                  let sum = formatter.format(bTotal);

                  let bills =
                  `<tr><td>${b.company}</td>
                  <td>${b.bill_type}</td>
                  <td>${b.cost}</td>
                  <td>${sum}</td></tr>`;
                  $('#bills').append(bills);
                })
              }
            })


        </script>


  </body>
</html>
